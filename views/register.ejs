<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title> Real madrid | Register </title>
  <link rel="icon" href="/styles/imgs/header/real-madrid-logo.png" sizes="64x64">

  <!-- Libraries -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="../styles/css/login.css">

</head>

<body>

  <main class="login">
    <div>
      <div class="img">
        <img src="../styles/imgs/tickets/logo_black.png" id="logo">
      </div>
      <h1>Welcome!</h1>
      <h5>Create your account</h5>

      <!-- הצגת הודעת שגיאה אם קיימת -->
      <% if (typeof error !== 'undefined' && error) { %>
      <div class="alert alert-danger" role="alert">
        <%= error %>
      </div>
      <% } %>

      <form id="registerForm">
        <input class="userDetails" name="fullname" placeholder="Full Name" required>
        <input class="userDetails" name="username" placeholder="Username" required>
        <input class="userDetails" name="password" type="password" placeholder="Password" required>
        
        <div class="image-upload">
          <img src="/styles/imgs/products/placeholder.png" class="srcImg-0" id="image-preview" width="150">
          <label for="imageUpload">Upload Image</label>
          <input type="file" accept="image/*" name="imageFile" onchange="onAddImg(event.target)" id="imageUpload">
        </div>

        <input type="hidden" name="imgURL" id="imgURL">

        <div class="btn">
          <button type="button" class="btn btn-primary" onclick="submitForm()">Register</button>
        </div>
      </form>

      <!-- אלמנט חדש להוספת הודעת השגיאה מתחת לטופס -->
      <div id="error-container"></div>

      <hr>
      Already a member? <a href="/login">Sign in</a>
    </div>
  </main>

  <!-- Libraries  -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"
    integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
  <script>
    function onAddImg(input) {
      if (input.files && input.files[0]) {
        let reader = new FileReader();
        reader.readAsDataURL(input.files[0]);
        reader.onload = function (e) {
          document.getElementById('image-preview').src = e.target.result;
          document.getElementById('imgURL').value = e.target.result;
        };
      }
    }

    function submitForm() {
      const form = document.getElementById('registerForm');
      const formData = new FormData(form);

      const data = {
        fullname: formData.get('fullname'),
        username: formData.get('username'),
        password: formData.get('password'),
        imgURL: formData.get('imgURL')
      };

      fetch('/login/register', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      }).then(async response => {
        const result = await response.json();
        if (response.ok) {
          window.location.href = '/';
        } else {
          // הצגת הודעת שגיאה
          showError(result.error || 'Registration failed');
        }
      }).catch(error => {
        console.error('Error:', error);
        showError('Registration failed due to a network error');
      });
    }

    function showError(message) {
      const errorDiv = document.createElement('div');
      errorDiv.className = 'alert alert-danger';
      errorDiv.role = 'alert';
      errorDiv.innerText = message;

      const errorContainer = document.getElementById('error-container');
      errorContainer.innerHTML = ''; // מנקה הודעות קודמות אם קיימות
      errorContainer.appendChild(errorDiv);
    }
  </script>
</body>

</html>
